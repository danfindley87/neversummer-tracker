<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Never Summer Tracker</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 70%;
      transition: height 0.4s ease-in-out;
    }

    #elevationContainer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 30%;
      background: white;
      transition: height 0.4s ease-in-out, opacity 0.4s ease-in-out;
    }

    #elevationChart {
      width: 100%;
      height: 100%;
    }

    #stats {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-size: 14px;
    }

    #controls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: white;
      padding: 8px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-size: 13px;
    }

    button {
      margin: 5px 0;
      padding: 5px 8px;
      cursor: pointer;
    }

    #toggleChart {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 5px;
      padding: 3px 8px;
      font-size: 13px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: bottom 0.4s ease-in-out;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="elevationContainer">
    <canvas id="elevationChart"></canvas>
  </div>
  <div id="stats">
    Mile: <span id="mile">0</span> |
    Elev: <span id="elev">0 ft</span> |
    Remain: <span id="remain">0 mi</span><br>
    Climbed: <span id="climbed">0 ft</span> | To Go: <span id="climbRemain">0 ft</span><br>
    Location last updated: <span id="lastUpdate">--</span><br>
    Current Pace: <span id="pace">--</span> | Avg Pace: <span id="avgPace">--</span><br>
    Est Finish: <span id="estFinish">--</span>
  </div>
  <div id="controls">
    <label><input type="checkbox" id="toggleRadar" checked> Weather Radar</label><br>
    Radar Strength: <span id="radarStrength">10x</span><br>
    <button id="refreshRadar">Refresh Radar</button><br>
    <button id="zoomRunner">Zoom to Runner</button>
    <button id="zoomCourse">Zoom to Course</button>
  </div>
  <div id="toggleChart">Elevation ▼</div>

  <script>
    mapboxgl.accessToken = 'YOUR_MAPBOX_TOKEN_HERE';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/outdoors-v12',
      center: [-105.9, 40.5],
      zoom: 10
    });

    let courseBounds;

    // Runner marker with white background
    const runnerIcon = document.createElement('div');
    runnerIcon.innerHTML = '🏃';
    runnerIcon.style.fontSize = '24px';
    runnerIcon.style.background = 'white';
    runnerIcon.style.borderRadius = '50%';
    runnerIcon.style.padding = '3px';
    const liveMarker = new mapboxgl.Marker(runnerIcon).setLngLat([-106.00294, 40.50903]).addTo(map);

    // Aid stations
    const aidStations = [
      { name: "Michigan Ditch (mile 11.4)", coords: [-105.8797, 40.4975], mile: 11.4 },
      { name: "Diamond Aid (mile 19.5)", coords: [-105.9081, 40.5039], mile: 19.5 },
      { name: "Montgomery (mile 25.5)", coords: [-105.9139, 40.5542], mile: 25.5 },
      { name: "Ruby Jewel Aid (mile 31.6)", coords: [-105.9633, 40.5842], mile: 31.6 },
      { name: "Clear Lake 1&2 (40.9 & 45.3)", coords: [-106.0022, 40.6553], mile: 40.9 },
      { name: "Canadian Aid (mile 51.5)", coords: [-106.0081, 40.6147], mile: 51.5 },
      { name: "Bockman Aid (mile 57.4)", coords: [-105.9717, 40.5592], mile: 57.4 },
      { name: "Ranger Lakes Aid (63.6)", coords: [-105.9675, 40.5036], mile: 63.6 }
    ];

    aidStations.forEach(station => {
      const el = document.createElement('div');
      el.innerHTML = '❌';
      el.style.fontSize = '20px';
      new mapboxgl.Marker(el).setLngLat(station.coords).setPopup(new mapboxgl.Popup().setText(station.name)).addTo(map);
    });

    // Zoom Buttons
    document.getElementById('zoomRunner').addEventListener('click', () => {
      const runnerPos = liveMarker.getLngLat();
      map.flyTo({ center: runnerPos, zoom: 14 });
    });

    document.getElementById('zoomCourse').addEventListener('click', () => {
      if (courseBounds) map.fitBounds(courseBounds, { padding: 40 });
    });

    // Elevation Toggle
    document.getElementById('toggleChart').addEventListener('click', () => {
      const mapDiv = document.getElementById('map');
      const chartDiv = document.getElementById('elevationContainer');
      const btn = document.getElementById('toggleChart');

      if (chartDiv.style.height === '0px' || chartDiv.style.height === '0%') {
        chartDiv.style.height = '30%';
        chartDiv.style.opacity = 1;
        mapDiv.style.height = '70%';
        btn.textContent = 'Elevation ▼';
      } else {
        chartDiv.style.height = '0%';
        chartDiv.style.opacity = 0;
        mapDiv.style.height = '100%';
        btn.textContent = 'Elevation ▲';
      }

      setTimeout(() => map.resize(), 400);
    });

    // Weather Radar
    const radarLayers = [];
    function addRadar() {
      removeRadar();
      for (let i = 0; i < 10; i++) {
        const layerId = `radar-${i}`;
        radarLayers.push(layerId);
        map.addSource(layerId, {
          type: 'raster',
          tiles: [
            `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=YOUR_OWM_API_KEY`
          ],
          tileSize: 256
        });
        map.addLayer({
          id: layerId,
          type: 'raster',
          source: layerId,
          paint: { 'raster-opacity': 0.5 }
        });
      }
    }

    function removeRadar() {
      radarLayers.forEach(id => {
        if (map.getLayer(id)) map.removeLayer(id);
        if (map.getSource(id)) map.removeSource(id);
      });
      radarLayers.length = 0;
    }

    document.getElementById('toggleRadar').addEventListener('change', (e) => {
      if (e.target.checked) {
        addRadar();
      } else {
        removeRadar();
      }
    });

    document.getElementById('refreshRadar').addEventListener('click', addRadar);

    map.on('load', () => {
      addRadar();
      // Fit map to course bounds if you have them
    });
  </script>
</body>
</html>
