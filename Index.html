<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Never Summer Tracker</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 70%;
      transition: height 0.3s ease;
    }
    #elevationContainer {
      height: 30%;
      transition: height 0.3s ease, opacity 0.3s ease;
      opacity: 1;
      background: white;
    }
    #elevationChart {
      width: 100%;
      height: 100%;
    }
    #infoBox {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 2;
      line-height: 1.4em;
    }
    #controls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 2;
    }
    #toggleChart {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 3;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-weight: bold;
    }
    .emoji-marker {
      font-size: 18px;
      text-align: center;
      line-height: 32px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: white;
      border: 2px solid #333;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <button id="toggleChart">Elevation â–¼</button>
  <div id="elevationContainer">
    <canvas id="elevationChart"></canvas>
  </div>

  <div id="infoBox">
    <div>Mile: <span id="mile">0</span> | Elev: <span id="elev">0</span> ft | Remain: <span id="remain">0</span> mi</div>
    <div>Climbed: <span id="climbed">0</span> ft | To Go: <span id="climbToGo">0</span> ft</div>
    <div>Location last updated: <span id="lastUpdated">--</span></div>
    <div>Current Pace: <span id="currentPace">--</span> min/mi</div>
    <div>Avg Pace: <span id="avgPace">--</span> min/mi</div>
    <div>Est Finish: <span id="estFinish">--</span></div>
  </div>

  <div id="controls">
    <label>
      <input type="checkbox" id="toggleRadar" checked /> Weather Radar
    </label>
    <br/>
    <button id="refreshRadar">Refresh Radar</button>
    <button id="zoomRunner">Zoom to Runner</button>
    <button id="zoomCourse">Zoom to Course</button>
  </div>

  <script>
    mapboxgl.accessToken = 'YOUR_MAPBOX_TOKEN_HERE';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/outdoors-v12',
      center: [-106.00294, 40.50903],
      zoom: 10
    });

    let courseBounds = null;
    let courseGeojson = null;
    const aidStations = [
      { name: "Michigan Ditch (mile 11.4)", coords: [-105.8797, 40.4975], mile: 11.4 },
      { name: "Diamond Aid (mile 19.5)", coords: [-105.9081, 40.5039], mile: 19.5 },
      { name: "Montgomery (mile 25.5)", coords: [-105.9139, 40.5542], mile: 25.5 },
      { name: "Ruby Jewel Aid (mile 31.6)", coords: [-105.9633, 40.5842], mile: 31.6 },
      { name: "Clear Lake 1&2 (40.9 & 45.3)", coords: [-106.0022, 40.6553], mile: 40.9 },
      { name: "Canadian Aid (mile 51.5)", coords: [-106.0081, 40.6147], mile: 51.5 },
      { name: "Bockman Aid (mile 57.4)", coords: [-105.9717, 40.5592], mile: 57.4 },
      { name: "Ranger Lakes Aid (63.6)", coords: [-105.9675, 40.5036], mile: 63.6 }
    ];

    // Load course and draw it
    fetch('course.geojson')
      .then(resp => resp.json())
      .then(data => {
        courseGeojson = data;
        map.on('load', () => {
          map.addSource('course', { type: 'geojson', data });
          map.addLayer({
            id: 'course-line',
            type: 'line',
            source: 'course',
            paint: { 'line-color': '#FF4500', 'line-width': 4 }
          });
          const coords = data.features[0].geometry.coordinates.map(c => [c[0], c[1]]);
          courseBounds = coords.reduce((bounds, coord) => bounds.extend(coord), new mapboxgl.LngLatBounds(coords[0], coords[0]));
          map.fitBounds(courseBounds, { padding: 40 });

          // Start marker
          new mapboxgl.Marker({ element: createEmojiMarker('ðŸ', true) })
            .setLngLat(coords[coords.length - 1])
            .addTo(map);

          new mapboxgl.Marker({ element: createEmojiMarker('ðŸ³ï¸', true) })
            .setLngLat(coords[0])
            .addTo(map);

          // Aid station markers
          aidStations.forEach(aid => {
            new mapboxgl.Marker({ element: createEmojiMarker('âŒ') })
              .setLngLat(aid.coords)
              .setPopup(new mapboxgl.Popup().setText(aid.name))
              .addTo(map);
          });

          // Runner marker
          runnerMarker.setLngLat(coords[Math.floor(coords.length / 10)]).addTo(map);
        });
      });

    function createEmojiMarker(emoji, large = false) {
      const el = document.createElement('div');
      el.className = 'emoji-marker';
      el.style.fontSize = large ? '22px' : '18px';
      el.textContent = emoji;
      return el;
    }

    const runnerMarker = new mapboxgl.Marker({ element: createEmojiMarker('ðŸƒâ€â™‚ï¸', true) });

    // Elevation chart toggle
    document.getElementById('toggleChart').addEventListener('click', () => {
      const mapDiv = document.getElementById('map');
      const chartDiv = document.getElementById('elevationContainer');
      const btn = document.getElementById('toggleChart');

      if (chartDiv.style.height === '0px' || chartDiv.style.height === '0%') {
        chartDiv.style.height = '30%';
        chartDiv.style.opacity = 1;
        mapDiv.style.height = '70%';
        btn.textContent = 'Elevation â–¼';
      } else {
        chartDiv.style.height = '0%';
        chartDiv.style.opacity = 0;
        mapDiv.style.height = '100%';
        btn.textContent = 'Elevation â–²';
      }
    });

    // Zoom buttons
    document.getElementById('zoomRunner').addEventListener('click', () => {
      if (runnerMarker.getLngLat()) {
        map.flyTo({ center: runnerMarker.getLngLat(), zoom: 13 });
      }
    });
    document.getElementById('zoomCourse').addEventListener('click', () => {
      if (courseBounds) map.fitBounds(courseBounds, { padding: 40 });
    });

    // Radar controls
    document.getElementById('toggleRadar').addEventListener('change', (e) => {
      console.log('Radar toggled:', e.target.checked);
    });
    document.getElementById('refreshRadar').addEventListener('click', () => {
      console.log('Radar refreshed');
    });
  </script>
</body>
</html>
